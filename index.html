<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jamie Bothwell Blast</title>
  <link rel="stylesheet" href="styles.css">
  
  <!-- Particles.js for background effect -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
</head>

<body>
  <!-- Particle background -->
  <div id="particles-js"></div>
  
  <header>
    <h1>JAMIE BOTHWELL BLAST</h1>
    <p class="tagline">The Ultimate Retro Shooter Experience</p>
  </header>

  <div id="canvas-container">
    <canvas id="canvas" width="1024" height="600" oncontextmenu="event.preventDefault()" tabindex="1"></canvas>
    
    <div id="game-overlay">
      <div class="spinner"></div>
      <div id="status-text" class="pulse">Initializing Game Environment...</div>
      <progress id="progress" value="0" max="100"></progress>
      <div id="game-controls">
        <button id="play-button" class="control-btn" disabled>LOADING GAME...</button>
        <button id="fullscreen-button" class="control-btn">GO FULLSCREEN</button>
      </div>
    </div>
  </div>

  <div id="description-section">
    <h2>ABOUT THE GAME</h2>
    <p>Jamie Bothwell Blast is an explosive retro shooter that combines classic arcade action with modern gameplay mechanics. Blast your way through waves of enemies, collect power-ups, and defeat massive bosses in this adrenaline-fueled adventure!</p>
    
    <div class="features">
      <div class="feature-card">
        <h3>ARCADE ACTION</h3>
        <p>Fast-paced shooting with retro-inspired visuals</p>
      </div>
      <div class="feature-card">
        <h3>POWER UPS</h3>
        <p>Collect weapon upgrades and special abilities</p>
      </div>
      <div class="feature-card">
        <h3>EPIC BOSSES</h3>
        <p>Challenge massive end-level bosses</p>
      </div>
      <div class="feature-card">
        <h3>HIGH SCORES</h3>
        <p>Compete for the top spot on the leaderboard</p>
      </div>
    </div>
    
    <div class="instructions">
      <h3>HOW TO PLAY</h3>
      <ul>
        <li><strong>MOVEMENT:</strong> Use <strong>WASD</strong> or <strong>Arrow Keys</strong> to move your ship</li>
        <li><strong>SHOOT:</strong> Press <strong>SPACEBAR</strong> or <strong>LEFT MOUSE</strong> to fire</li>
        <li><strong>SPECIAL:</strong> Press <strong>E</strong> for special attacks</li>
        <li><strong>POWER-UPS:</strong> Collect colored orbs for enhanced weapons</li>
        <li><strong>BOSS WEAKNESS:</strong> Aim for the glowing weak points!</li>
      </ul>
    </div>
  </div>

  <footer>
    <p>Â© 2023 Jamie Bothwell Blast | Built with PyGame and Pygbag | All Rights Reserved</p>
  </footer>

  <!-- Pygbag configuration -->
  <script>
    window.config = {
      xtermjs: "1",
      _sdl2: "canvas",
      user_canvas: 1,
      user_canvas_managed: 1,
      ume_block: 0,
      can_close: 0,
      archive: "jamiebothwellblast",
      gui_debug: 3,
      cdn: "https://pygame-web.github.io/archives/0.9/",
      autorun: 0,
      PYBUILD: "3.12",
      user_canvas_element: "canvas"
    };
  </script>

  <!-- Pygbag runtime -->
  <script src="https://pygame-web.github.io/archives/0.9/pythons.js" type="module" id="site" 
          data-LINES="57" data-CONSOLE="25" data-python="python3.12" 
          data-os="vtx,fs,snd,gui" async defer>
    <!-- FIXED PYTHON CODE - SIMPLIFIED VERSION -->
    print("Booting JamieBothwellBlast...")
    
    WIDTH=1024
    HEIGHT=600
    REFX = 1980
    REFY = 1080
    
    def u(real, ref, v):
        if abs(v)<0.9999999:
            result = int((float(real)/100.0) * (v*1000))
            if v<0:
                return real-result
            return result
        return int((real/ref) * v)
    
    def ux(*argv):
        return sum([u(WIDTH, REFX, v) for v in argv])
    
    def uy(*argv):
        return sum([u(HEIGHT, REFY, v) for v in argv])
    
    async def custom_site():
        import platform
        import pygame
        import asyncio
        
        print("[PY] Initializing pygame...")
        pygame.init()
        pygame.font.init()
        
        # Create a minimal display surface
        screen = pygame.display.set_mode((100, 100))
        pygame.display.set_caption("Initializing...")
        
        # Set the main path directly
        platform.window.Module.main_path = "/data/data/jamiebothwellblast/assets/main.py"
        print(f"[PY] Main path set to: {platform.window.Module.main_path}")
        
        # Signal that main_path is ready
        platform.window.js.document.dispatchEvent(
            platform.window.js.Event.new('mainPathReady')
        )
        print("[PY] Dispatched mainPathReady event")
        
        # Keep the event loop running
        while True:
            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    return
            pygame.display.flip()
            await asyncio.sleep(0.1)
    
    import asyncio
    asyncio.run(custom_site())
    # -->
  </script>

  <script>
    // Initialize particle background
    particlesJS('particles-js', {
      particles: {
        number: { value: 80, density: { enable: true, value_area: 800 } },
        color: { value: "#ff5722" },
        shape: { type: "circle" },
        opacity: { value: 0.5, random: true },
        size: { value: 3, random: true },
        line_linked: {
          enable: true,
          distance: 150,
          color: "#ff9800",
          opacity: 0.3,
          width: 1
        },
        move: {
          enable: true,
          speed: 2,
          direction: "none",
          random: true,
          straight: false,
          out_mode: "out",
          bounce: false
        }
      },
      interactivity: {
        detect_on: "canvas",
        events: {
          onhover: { enable: true, mode: "repulse" },
          onclick: { enable: true, mode: "push" }
        }
      }
    });

    // Get DOM elements
    const canvas = document.getElementById("canvas");
    const container = document.getElementById("canvas-container");
    const playButton = document.getElementById("play-button");
    const fullscreenButton = document.getElementById("fullscreen-button");
    const gameOverlay = document.getElementById("game-overlay");
    const progressBar = document.getElementById("progress");
    const statusText = document.getElementById("status-text");
    
    // Initialize Module if it doesn't exist
    window.Module = window.Module || {
      setStatus: function(text) {
        console.log("[JS] Status: " + text);
        statusText.textContent = text;
      },
      setProgress: function(value) {
        progressBar.value = value;
      }
    };
    
    // Set default main path as fallback
    Module.main_path = "/data/data/jamiebothwellblast/assets/main.py";
    
    // Handle high DPI displays
    function setupCanvas() {
      const dpr = window.devicePixelRatio || 1;
      
      // Set CSS dimensions (logical pixels)
      canvas.style.width = '1024px';
      canvas.style.height = '600px';
      
      // Set backing buffer size (physical pixels)
      canvas.width = 1024 * dpr;
      canvas.height = 600 * dpr;
      
      // Scale the context
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);
    }
    
    // Initial canvas setup
    setupCanvas();
    
    // Handle window resize
    window.addEventListener('resize', setupCanvas);
    
    // Update progress bar and status during loading
    Module.setStatus("Loading game assets...");
    
    // Handle runtime initialization
    Module.onRuntimeInitialized = function() {
      console.log("[JS] Runtime initialized!");
      Module.setStatus("Python runtime ready");
      playButton.textContent = "START GAME NOW";
      playButton.disabled = false;
    };
    
    // Listen for the mainPathReady event from Python
    document.addEventListener('mainPathReady', function() {
      console.log("[JS] mainPathReady event received!");
      Module.setStatus("Game assets loaded! Click Start Game");
      playButton.disabled = false;
    });
    
    // Play button functionality
    playButton.addEventListener("click", function() {
      console.log("[JS] Play button clicked");
      startGame();
    });
    
    // Core game start function
    function startGame() {
      console.log("[JS] Attempting to start game...");
      
      try {
        // Hide overlay with animation
        gameOverlay.style.opacity = '0';
        setTimeout(() => {
          gameOverlay.style.display = 'none';
        }, 500);
        
        // Execute game start commands
        if (typeof Module.PyRun_SimpleString === 'function') {
          Module.PyRun_SimpleString("import platform; platform.window.MM.UME = True");
          Module.PyRun_SimpleString(`import shell; shell.runpy("${Module.main_path}")`);
        } else {
          // Fallback if PyRun_SimpleString is not available
          Module.run();
        }
        
        // Focus the canvas for keyboard input
        canvas.focus();
        
        console.log("[JS] Game started successfully!");
      } catch (e) {
        console.error("[JS] Error starting game:", e);
        Module.setStatus("Error starting game. See console for details.");
        gameOverlay.style.display = 'flex';
        gameOverlay.style.opacity = '1';
      }
    }
    
    // Fullscreen button functionality
    fullscreenButton.addEventListener("click", function() {
      if (!document.fullscreenElement) {
        container.requestFullscreen().catch(err => {
          console.error(`Fullscreen error: ${err.message}`);
        });
        fullscreenButton.textContent = "EXIT FULLSCREEN";
      } else {
        document.exitFullscreen();
        fullscreenButton.textContent = "GO FULLSCREEN";
      }
    });
    
    // Handle fullscreen change
    document.addEventListener("fullscreenchange", function() {
      if (document.fullscreenElement) {
        fullscreenButton.textContent = "EXIT FULLSCREEN";
        // Adjust canvas size for fullscreen
        setTimeout(setupCanvas, 100);
      } else {
        fullscreenButton.textContent = "GO FULLSCREEN";
      }
    });
    
    // Handle visibility change to prevent audio issues
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        // Pause game when tab is not active
        if (typeof Module !== 'undefined' && Module.PyRun_SimpleString) {
          try {
            Module.PyRun_SimpleString("import pygame; pygame.mixer.music.pause()");
          } catch (e) {
            console.error("Error pausing music:", e);
          }
        }
      } else {
        // Resume game when tab becomes active
        if (typeof Module !== 'undefined' && Module.PyRun_SimpleString) {
          try {
            Module.PyRun_SimpleString("import pygame; pygame.mixer.music.unpause()");
          } catch (e) {
            console.error("Error unpausing music:", e);
          }
        }
      }
    });
    
    // Fallback timeout to enable play button
    setTimeout(() => {
      if (playButton.disabled) {
        console.log("[JS] Fallback timeout - enabling play button");
        Module.setStatus("Ready to play! Click Start Game");
        playButton.textContent = "START GAME";
        playButton.disabled = false;
      }
    }, 10000); // 10 seconds
    
    // Second fallback timeout to start game
    setTimeout(() => {
      if (gameOverlay.style.display !== 'none') {
        console.log("[JS] Fallback timeout - starting game automatically");
        startGame();
      }
    }, 20000); // 20 seconds
  </script>
</body>
</html>