<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jamie Bothwell Blast</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    #game-container {
      position: relative;
      width: 100%;
      max-width: 1024px;
      margin: 20px auto;
    }

    canvas {
      display: block;
      width: 100%;
      height: 600px;
      background: #000;
      border: 1px solid #333;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }

    #game-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }

    #game-controls {
      display: flex;
      gap: 20px;
      margin: 20px 0;
    }

    .control-btn {
      padding: 12px 24px;
      font-size: 1.1rem;
      font-weight: bold;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .control-btn:hover {
      background: #45a049;
    }

    #play-button {
      background: #2196F3;
    }

    #play-button:hover {
      background: #0b7dda;
    }

    #status-text {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #fff;
      text-align: center;
    }

    progress {
      width: 80%;
      max-width: 400px;
      height: 20px;
      margin: 20px 0;
    }

    #description {
      max-width: 800px;
      margin: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
  </style>

  <script>
    // Configuration for Pygbag
    window.config = {
      xtermjs: "1",
      _sdl2: "canvas",
      user_canvas: 1, // Use our canvas
      user_canvas_managed: 1, // Let Pygbag manage our canvas
      ume_block: 0,
      can_close: 0,
      archive: "jamiebothwellblast",
      gui_debug: 3,
      cdn: "https://pygame-web.github.io/archives/0.9/",
      autorun: 0,
      PYBUILD: "3.12"
    };
    
    // Initialize the Module object
    window.Module = {
      canvas: document.createElement('canvas'),
      setStatus: function(text) {
        if (document.getElementById('status-text')) {
          document.getElementById('status-text').textContent = text;
        }
      },
      setProgress: function(value) {
        if (document.getElementById('progress')) {
          document.getElementById('progress').value = value;
        }
      }
    };
  </script>
</head>

<body>
  <div id="game-container">
    <div id="game-overlay">
      <div id="status-text">Initializing game environment...</div>
      <progress id="progress" value="0" max="100"></progress>
      <div id="game-controls">
        <button id="play-button" class="control-btn" disabled>LOADING...</button>
        <button id="fullscreen-button" class="control-btn">FULLSCREEN</button>
      </div>
    </div>
  </div>
  
  <div id="description">
    <h2>About Jamie Bothwell Blast</h2>
    <p>An action-packed retro shooter with explosive gameplay! Blast your way through enemies, collect power-ups, and defeat challenging bosses.</p>
    <p>Controls: Arrow keys to move, Spacebar to shoot, E for special attacks.</p>
  </div>

  <!-- Pygbag runtime -->
  <script src="https://pygame-web.github.io/archives/0.9/pythons.js" type="module" id="site" 
          data-LINES="57" data-CONSOLE="25" data-python="python3.12" 
          data-os="vtx,fs,snd,gui" async defer>
    <!-- FIXED PYTHON CODE -->
    print("Booting JamieBothwellBlast...")
    
    # Screen dimensions
    WIDTH = 1024
    HEIGHT = 600
    
    # Reference dimensions
    REFX = 1980
    REFY = 1080
    
    def u(real, ref, v):
        if abs(v) < 0.9999999:
            result = int((float(real) / 100.0) * (v * 1000))
            if v < 0:
                return real - result
            return result
        return int((real / ref) * v)
    
    def ux(*argv):
        return sum([u(WIDTH, REFX, v) for v in argv])
    
    def uy(*argv):
        return sum([u(HEIGHT, REFY, v) for v in argv])
    
    async def custom_site():
        import platform
        import pygame
        import asyncio
        import json
        from pathlib import Path
        
        # Initialize pygame
        pygame.init()
        pygame.font.init()
        
        # Create a minimal display surface
        screen = pygame.display.set_mode((1, 1))
        pygame.display.set_caption("Initializing...")
        
        # Set up the application directory
        bundle = "jamiebothwellblast"
        appdir = Path(f"/data/data/{bundle}")
        appdir.mkdir(parents=True, exist_ok=True)
        
        # Set the main path
        main_path = appdir / "assets" / "main.py"
        platform.window.Module.main_path = str(main_path)
        
        # Signal that main_path is ready
        platform.window.js.document.dispatchEvent(
            platform.window.js.Event.new('mainPathReady')
        )
        
        # Keep the event loop running
        while True:
            for event in pygame.event.get():
                if event.type == pygame.QUIT:
                    return
            await asyncio.sleep(0.1)
    
    import asyncio
    asyncio.run(custom_site())
  </script>

  <script>
    // Get DOM elements
    const gameContainer = document.getElementById('game-container');
    const gameOverlay = document.getElementById('game-overlay');
    const playButton = document.getElementById('play-button');
    const fullscreenButton = document.getElementById('fullscreen-button');
    const progressBar = document.getElementById('progress');
    const statusText = document.getElementById('status-text');
    
    // Add the canvas to the container
    gameContainer.appendChild(Module.canvas);
    Module.canvas.id = 'game-canvas';
    Module.canvas.width = 1024;
    Module.canvas.height = 600;
    Module.canvas.style.display = 'none'; // Hide until game starts
    
    // Handle high DPI displays
    function setupCanvas() {
      const dpr = window.devicePixelRatio || 1;
      Module.canvas.width = 1024 * dpr;
      Module.canvas.height = 600 * dpr;
      
      const ctx = Module.canvas.getContext('2d');
      ctx.scale(dpr, dpr);
    }
    
    // Initial setup
    setupCanvas();
    window.addEventListener('resize', setupCanvas);
    
    // Update status during loading
    Module.setStatus = function(text) {
      statusText.textContent = text;
    };
    
    Module.setProgress = function(value) {
      progressBar.value = value;
    };
    
    // Handle runtime initialization
    Module.onRuntimeInitialized = function() {
      Module.setStatus("Python runtime ready");
      playButton.textContent = "START GAME";
      playButton.disabled = false;
    };
    
    // Listen for the mainPathReady event from Python
    document.addEventListener('mainPathReady', function() {
      Module.setStatus("Game assets loaded! Click Start Game");
      playButton.disabled = false;
    });
    
    // Play button functionality
    playButton.addEventListener('click', function() {
      startGame();
    });
    
    // Core game start function
    function startGame() {
      try {
        // Hide overlay
        gameOverlay.style.opacity = '0';
        setTimeout(() => {
          gameOverlay.style.display = 'none';
        }, 500);
        
        // Show canvas
        Module.canvas.style.display = 'block';
        
        // Start the game
        if (typeof Module.run === 'function') {
          Module.run();
        } else if (typeof Module.PyRun_SimpleString === 'function') {
          Module.PyRun_SimpleString("import platform; platform.window.MM.UME = True");
          Module.PyRun_SimpleString(`import shell; shell.runpy("${Module.main_path}")`);
        } else {
          Module.callMain([Module.main_path]);
        }
        
        // Focus the canvas
        Module.canvas.focus();
      } catch (e) {
        console.error("Error starting game:", e);
        Module.setStatus("Error starting game. See console for details.");
        gameOverlay.style.display = 'flex';
        gameOverlay.style.opacity = '1';
      }
    }
    
    // Fullscreen button functionality
    fullscreenButton.addEventListener('click', function() {
      if (!document.fullscreenElement) {
        gameContainer.requestFullscreen().catch(err => {
          console.error(`Fullscreen error: ${err.message}`);
        });
        fullscreenButton.textContent = "EXIT FULLSCREEN";
      } else {
        document.exitFullscreen();
        fullscreenButton.textContent = "FULLSCREEN";
      }
    });
    
    // Handle fullscreen change
    document.addEventListener('fullscreenchange', function() {
      if (document.fullscreenElement) {
        fullscreenButton.textContent = "EXIT FULLSCREEN";
        setTimeout(setupCanvas, 100);
      } else {
        fullscreenButton.textContent = "FULLSCREEN";
      }
    });
    
    // Fallback to enable play button
    setTimeout(() => {
      if (playButton.disabled) {
        playButton.textContent = "START GAME";
        playButton.disabled = false;
        Module.setStatus("Ready to play!");
      }
    }, 5000);
  </script>
</body>
</html>