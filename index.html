<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Pygbag Game</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #e0e0e0;
    }

    #game-container {
      text-align: center;
      padding-top: 20px;
    }

    canvas {
      border: 1px solid #000;
      max-width: 100%;
      height: auto;
    }

    #game-controls {
      margin: 10px 0;
    }

    #game-controls button {
      padding: 10px 20px;
      font-size: 1rem;
      margin: 0 5px;
      cursor: pointer;
    }

    #description-section {
      max-width: 800px;
      margin: 20px auto;
      padding: 15px;
      background-color: #ffffff;
      border: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    #transfer {
      text-align: center;
      margin-top: 20px;
    }

    #status {
      font-weight: bold;
      margin-bottom: 10px;
    }

    progress {
      width: 300px;
      height: 20px;
    }
  </style>

  <script type="application/javascript">
    config = {
      xtermjs: "1",
      _sdl2: "canvas",
      user_canvas: 0,
      user_canvas_managed: 0,
      ume_block: 1,
      can_close: 0,
      archive: "jamiebothwellblast",
      gui_debug: 3,
      cdn: "https://pygame-web.github.io/archives/0.9/",
      autorun: 0,
      PYBUILD: "3.12"
    };
  </script>
</head>

<body>

<!-- INLINE PYTHON SCRIPT BLOCK (Required for Pygbag) -->
<script type="module">
import { run } from "https://pygame-web.github.io/archives/0.9/pythons.js";

await run(async () => {
  print("Loading game...");

  const WIDTH = 1024;
  const HEIGHT = 600;
  const REFX = 1980;
  const REFY = 1080;

  function u(real, ref, v) {
    if (Math.abs(v) < 0.9999999) {
      const result = Math.floor((real / 100.0) * (v * 1000));
      return v < 0 ? real - result : result;
    }
    return Math.floor((real / ref) * v);
  }

  function ux(...vals) {
    return vals.reduce((acc, v) => acc + u(WIDTH, REFX, v), 0);
  }

  function uy(...vals) {
    return vals.reduce((acc, v) => acc + u(HEIGHT, REFY, v), 0);
  }

  const platform = window.platform;
  const pygame = await import("pygame");
  await pygame.init();
  await pygame.font.init();

  const screen = pygame.display.set_mode([ux(.8), uy(.6)], pygame.SRCALPHA, 32);
  screen.set_colorkey([0, 0, 0, 0], pygame.RLEACCEL);
  screen.fill([0, 0, 0, 0]);
  pygame.display.flip();

  const apk = "jamiebothwellblast.apk";
  const bundle = "jamiebothwellblast";
  const appdir = new window.Path(`/data/data/${bundle}`);
  await appdir.mkdir();

  const cfg = {
    io: "url",
    type: "mount",
    mount: {
      point: appdir.as_posix(),
      path: "/",
    },
    path: `/ => ${appdir.as_posix()}`
  };

  const track = platform.window.MM.prepare(apk, JSON.stringify(cfg));

  function pg_bar(pos) {
    const marginx = ux(0.02);
    const marginy = uy(0.045);
    const total = track.len || 10;
    const slot = ux(0.06) / total;
    pygame.draw.rect(screen, [10, 10, 10], [marginx - ux(10), marginy - uy(10), (total * slot) + ux(20), uy(110)]);
    pygame.draw.rect(screen, [0, 255, 0], [marginx, marginy, track.pos * slot, uy(90)]);
  }

  while (!track.ready) {
    pg_bar(track.pos);
    pygame.display.flip();
    await new Promise(resolve => setTimeout(resolve, 100));
  }

  pg_bar(track.len);
  pygame.display.flip();

  const main = appdir.join("assets/main.py");

  await window.shell.runpy(main);
});
</script>

<!-- Transfer Status -->
<div id="transfer">
  <div id="status">Downloading...</div>
  <progress id="progress" value="0" max="100"></progress>
</div>

<!-- Game Canvas -->
<div id="game-container">
  <canvas id="canvas"
    width="1024" height="600"
    oncontextmenu="event.preventDefault()"
    tabindex="1" class="emscripten">
  </canvas>

  <!-- Controls -->
  <div id="game-controls">
    <button id="play-button">Play</button>
    <button id="fullscreen-button">Fullscreen</button>
  </div>
</div>

<!-- Description -->
<div id="description-section">
  <h2>About the Game</h2>
  <p>Welcome to Jamie Bothwell Blast! Dodge and destroy enemies in this retro-style pixel shooter. Click "Play" to begin, and "Fullscreen" to hide this description for an immersive experience.</p>
</div>

<!-- JS for controls -->
<script>
const canvas = document.getElementById("canvas");
const playButton = document.getElementById("play-button");
const fullscreenButton = document.getElementById("fullscreen-button");
const description = document.getElementById("description-section");

playButton.addEventListener("click", () => {
  if (Module && Module.PyRun_SimpleString) {
    Module.PyRun_SimpleString("platform.window.MM.UME = True");
    Module.PyRun_SimpleString("shell.runpy(main)");
  }
  playButton.style.display = "none";
});

fullscreenButton.addEventListener("click", () => {
  if (!document.fullscreenElement) {
    canvas.requestFullscreen().catch((err) => {
      console.error(`Fullscreen error: ${err.message}`);
    });
  } else {
    document.exitFullscreen();
  }
});

document.addEventListener("fullscreenchange", () => {
  if (document.fullscreenElement) {
    description.style.display = "none";
  } else {
    description.style.display = "block";
  }
});
</script>

</body>
</html>